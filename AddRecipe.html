<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Recipe - TasteTrove</title>
    <link rel="website icon" type="png" href="./Logo2.png" />
    <link rel="stylesheet" href="style.css" />
    <style>
      .form-container {
        max-width: 800px;
        margin: 120px auto 40px;
        padding: 20px;
        background-color: #f5f5f5;
        border-radius: 10px;
        margin-top: 0px;
      }

      .form-title {
        text-align: center;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }

      .ingredient-section,
      .step-section {
        background-color: #e7d3bb;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
      }

      .ingredient-list,
      .step-list {
        margin-bottom: 10px;
      }

      .ingredient-item,
      .step-item {
        display: flex;
        margin-bottom: 5px;
      }

      .macros-item {
        display: flex;
        margin-bottom: 5px;
        gap: 10px;
      }

      .macros-item input {
        flex: 1;
      }

      .remove-btn {
        background-color: #ff6b6b;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        margin-left: 10px;
        cursor: pointer;
      }

      .add-btn {
        background-color: #4ecdc4;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        margin-right: 10px;
      }

      .section-controls {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
      }

      .submit-btn {
        background-color: #e7d3bb;
        color: black;
        border: none;
        border-radius: 4px;
        padding: 12px 24px;
        font-size: 18px;
        cursor: pointer;
        display: block;
        margin: 20px auto 0;
        transition: background-color 0.3s;
      }

      .submit-btn:hover {
        background-color: #d4b99a;
      }

      .hint {
        font-size: 14px;
        color: #666;
        margin-top: 2px;
      }

      /* Darkmode styles */
      .dark-mode .form-container {
        background-color: #2d2d2d;
        color: #ffffff;
      }

      .dark-mode input,
      .dark-mode select,
      .dark-mode textarea {
        background-color: #404040;
        color: #ffffff;
        border-color: #666;
      }

      .dark-mode .ingredient-section,
      .dark-mode .step-section {
        background-color: #404040;
      }

      .dark-mode .submit-btn {
        background-color: #404040;
        color: #ffffff;
      }

      .dark-mode .submit-btn:hover {
        background-color: #666;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo-container">
        <img src="./Logo2.png" alt="Chef Hat Logo" class="logo-img" />
        <div class="name-tagline">
          <h1
            class="logo-text"
            style="
              font-family: 'Times New Roman', Times, serif;
              font-size: xx-large;
            "
          >
            TasteTrove
          </h1>
          <h3>Find It,Cook It,Love It..</h3>
        </div>
      </div>
      <div class="profile-container">
        <button id="toggle-button" style="margin-left: 20px">
          <svg
            id="dark-icon"
            xmlns="http://www.w3.org/2000/svg"
            height="24px"
            viewBox="0 -960 960 960"
            width="24px"
          >
            <path
              d="M480-280q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-440H40v-80h160v80Zm720 0H760v-80h160v80ZM440-760v-160h80v160h-80Zm0 720v-160h80v160h-80ZM256-650l-101-97 57-59 96 100-52 56Zm492 496-97-101 53-55 101 97-57 59Zm-98-550 97-101 59 57-100 96-56-52ZM154-212l101-97 55 53-97 101-59-57Z"
            />
          </svg>
          <svg
            id="light-icon"
            xmlns="http://www.w3.org/2000/svg"
            height="24px"
            viewBox="0 -960 960 960"
            width="24px"
            style="display: none"
          >
            <path
              d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Z"
            />
          </svg>
        </button>
        <div class="username-display" id="headerUsername">User</div>
        <img
          src="./Profile.jpg"
          alt="Profile"
          class="profile-img"
          id="profileImg"
        />
        <div class="profile-dropdown" id="profileDropdown">
          <div class="dropdown-username" id="username">Loading...</div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" id="resetPasswordBtn">Reset Password</div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" id="signoutBtn">Sign Out</div>
        </div>
      </div>
    </header>
    <a href="./home.html" class="back-btn">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="25"
        height="25"
        fill="currentColor"
        class="bi bi-arrow-left-circle"
        viewBox="0 0 16 16"
      >
        <path
          fill-rule="evenodd"
          d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z"
        />
      </svg>
    </a>
    <div class="form-container">
      <h2 class="form-title">Add New Recipe</h2>
      <form id="recipe-form">
        <!-- Basic Info -->
        <div class="form-group">
          <label for="recipe-name">Recipe Name*</label>
          <input type="text" id="recipe-name" required />
        </div>

        <div class="form-group">
          <label for="recipe-category">Category*</label>
          <select id="recipe-category" required>
            <option value="">Select a category</option>
            <option value="veg">Vegetarian</option>
            <option value="non-veg">Non-Vegetarian</option>
            <option value="sweets">Sweets</option>
          </select>
        </div>

        <div class="form-group">
          <label for="recipe-image">Image URL</label>
          <input
            type="text"
            id="recipe-image"
            placeholder="https://example.com/image.jpg"
          />
          <p class="hint">Leave blank to use a placeholder image</p>
        </div>

        <div class="form-group">
          <label for="prep-time">Preparation Time(in mins)</label>
          <input type="number" id="prep-time" placeholder="e.g. 30 " />
        </div>

        <div class="form-group">
          <label for="cook-time">Cooking Time(in mins)</label>
          <input type="number" id="cook-time" placeholder="e.g. 45 " />
        </div>

        <div class="form-group">
          <label for="servings">Servings</label>
          <input type="number" id="servings" min="1" placeholder="4" />
        </div>

        <!-- Ingredients -->
        <h3>Ingredients*</h3>
        <div id="ingredients-container">
          <!-- Ingredient sections will be added here -->
          <div class="ingredient-section" id="ingredient-section-1">
            <div class="form-group">
              <label for="section-title-1">Section Title</label>
              <input
                type="text"
                id="section-title-1"
                placeholder="Main Ingredients (optional)"
              />
            </div>

            <div class="ingredient-list" id="ingredient-list-1">
              <div class="ingredient-item">
                <input
                  type="text"
                  class="ingredient-input"
                  placeholder="Ingredient with quantity"
                />
                <button type="button" class="remove-btn">Remove</button>
              </div>
            </div>

            <div class="section-controls">
              <button type="button" class="add-btn" data-section="1">
                Add Ingredient
              </button>
              <button type="button" class="remove-btn" id="remove-section-1">
                Remove Section
              </button>
            </div>
          </div>
        </div>

        <button type="button" id="add-section" class="add-btn">
          Add Ingredient Section
        </button>

        <!-- Steps -->
        <h3>Recipe Steps*</h3>
        <div id="steps-container">
          <div class="step-list">
            <div class="step-item">
              <input type="text" class="step-input" placeholder="Step 1" />
              <button type="button" class="remove-btn">Remove</button>
            </div>
          </div>

          <button type="button" id="add-step" class="add-btn">Add Step</button>
        </div>

        <!-- Macros -->
        <h3>Nutritional Information (Optional)</h3>
        <div id="macros-container">
          <div class="macros-list">
            <div class="macros-item">
              <input
                type="text"
                class="macros-key"
                placeholder="Nutrient (e.g., Calories)"
              />
              <input
                type="text"
                class="macros-value"
                placeholder="Value (e.g., 250)"
              />
              <button type="button" class="remove-btn">Remove</button>
            </div>
          </div>

          <button type="button" id="add-macro" class="add-btn">
            Add Macro
          </button>
        </div>

        <button type="submit" class="submit-btn">Add Recipe</button>
      </form>
    </div>

    <script type="module">
      import { addRecipe, getCurrentUser } from "./firebase.js";

      document.addEventListener("DOMContentLoaded", async function () {
        // Check if user is logged in
        const user = await getCurrentUser();
        if (!user) {
          alert("You need to log in to add a recipe");
          window.location.href = "login.html";
          return;
        }

        // Set up form event listeners
        setupForm();
      });

      function setupForm() {
        // Add ingredient
        document.addEventListener("click", function (e) {
          if (
            e.target.classList.contains("add-btn") &&
            e.target.dataset.section
          ) {
            const sectionId = e.target.dataset.section;
            addIngredient(sectionId);
          }
        });

        // Remove ingredient or step
        document.addEventListener("click", function (e) {
          if (e.target.classList.contains("remove-btn")) {
            const parent = e.target.parentElement;
            if (
              parent.classList.contains("ingredient-item") ||
              parent.classList.contains("step-item")
            ) {
              parent.remove();
            }
          }
        });

        // Remove section
        document.addEventListener("click", function (e) {
          if (e.target.id.startsWith("remove-section-")) {
            const sectionId = e.target.id.replace("remove-section-", "");
            const section = document.getElementById(
              `ingredient-section-${sectionId}`
            );

            // Don't remove the last section
            const sections = document.querySelectorAll(".ingredient-section");
            if (sections.length > 1) {
              section.remove();
            } else {
              alert("You need at least one ingredients section");
            }
          }
        });

        // Add step
        document
          .getElementById("add-step")
          .addEventListener("click", function () {
            addStep();
          });

        // Add ingredient section
        document
          .getElementById("add-section")
          .addEventListener("click", function () {
            addIngredientSection();
          });

        // Form submission
        document
          .getElementById("recipe-form")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            try {
              const recipeData = collectFormData();

              if (!recipeData.name) {
                alert("Recipe name is required");
                return;
              }

              if (!recipeData.category) {
                alert("Category is required");
                return;
              }

              if (recipeData.ingredients.length === 0) {
                alert("At least one ingredient is required");
                return;
              }

              if (recipeData.steps.length === 0) {
                alert("At least one step is required");
                return;
              }

              // Add user ID and timestamp
              const user = await getCurrentUser();
              recipeData.userId = user.uid;
              recipeData.createdAt = new Date().toISOString();

              // Submit to Firebase
              const submitBtn = document.querySelector(".submit-btn");
              submitBtn.textContent = "Adding Recipe...";
              submitBtn.disabled = true;

              const result = await addRecipe(recipeData);

              if (result.success) {
                alert("Recipe added successfully!");
                window.location.href = `recipe-detail.html?id=${result.id}`;
              } else {
                throw new Error(result.error);
              }
            } catch (error) {
              console.error("Error adding recipe:", error);
              alert(`Failed to add recipe: ${error.message}`);

              // Reset button
              const submitBtn = document.querySelector(".submit-btn");
              submitBtn.textContent = "Add Recipe";
              submitBtn.disabled = false;
            }
          });

        // Add macro
        document
          .getElementById("add-macro")
          .addEventListener("click", function () {
            addMacro();
          });

        // Remove macro
        document.addEventListener("click", function (e) {
          if (e.target.classList.contains("remove-btn")) {
            const parent = e.target.parentElement;
            if (parent.classList.contains("macros-item")) {
              parent.remove();
            }
          }
        });
      }

      function addIngredient(sectionId) {
        const list = document.getElementById(`ingredient-list-${sectionId}`);
        const item = document.createElement("div");
        item.className = "ingredient-item";
        item.innerHTML = `
        <input type="text" class="ingredient-input" placeholder="Ingredient with quantity">
        <button type="button" class="remove-btn">Remove</button>
      `;
        list.appendChild(item);
      }

      function addStep() {
        const list = document.querySelector(".step-list");
        const items = list.querySelectorAll(".step-item");
        const item = document.createElement("div");
        item.className = "step-item";
        item.innerHTML = `
        <input type="text" class="step-input" placeholder="Step ${
          items.length + 1
        }">
        <button type="button" class="remove-btn">Remove</button>
      `;
        list.appendChild(item);
      }

      function addIngredientSection() {
        const container = document.getElementById("ingredients-container");
        const sections = container.querySelectorAll(".ingredient-section");
        const newSectionId = sections.length + 1;

        const section = document.createElement("div");
        section.className = "ingredient-section";
        section.id = `ingredient-section-${newSectionId}`;
        section.innerHTML = `
        <div class="form-group">
          <label for="section-title-${newSectionId}">Section Title</label>
          <input type="text" id="section-title-${newSectionId}" placeholder="Section Title (optional)">
        </div>
        
        <div class="ingredient-list" id="ingredient-list-${newSectionId}">
          <div class="ingredient-item">
            <input type="text" class="ingredient-input" placeholder="Ingredient with quantity">
            <button type="button" class="remove-btn">Remove</button>
          </div>
        </div>
        
        <div class="section-controls">
          <button type="button" class="add-btn" data-section="${newSectionId}">Add Ingredient</button>
          <button type="button" class="remove-btn" id="remove-section-${newSectionId}">Remove Section</button>
        </div>
      `;

        container.appendChild(section);
      }

      function addMacro() {
        const list = document.querySelector(".macros-list");
        const item = document.createElement("div");
        item.className = "macros-item";
        item.innerHTML = `
      <input type="text" class="macros-key" placeholder="Nutrient (e.g., Calories)" />
      <input type="text" class="macros-value" placeholder="Value (e.g., 250)" />
      <button type="button" class="remove-btn">Remove</button>
    `;
        list.appendChild(item);
      }

      function collectFormData() {
        const recipe = {
          name: document.getElementById("recipe-name").value.trim(),
          category: document.getElementById("recipe-category").value,
          imageUrl: document.getElementById("recipe-image").value.trim(),
          prepTime: document.getElementById("prep-time").value.trim(),
          cookTime: document.getElementById("cook-time").value.trim(),
          servings: parseInt(document.getElementById("servings").value) || 0,
          ingredients: [],
          steps: [],
          macros: {},
        };

        // Collect ingredients
        const sections = document.querySelectorAll(".ingredient-section");
        sections.forEach((section) => {
          const sectionId = section.id.replace("ingredient-section-", "");
          const sectionTitle = document
            .getElementById(`section-title-${sectionId}`)
            .value.trim();
          const ingredientInputs =
            section.querySelectorAll(".ingredient-input");

          const items = [];
          ingredientInputs.forEach((input) => {
            const value = input.value.trim();
            if (value) {
              items.push(value);
            }
          });

          if (items.length > 0) {
            recipe.ingredients.push({
              section: sectionTitle || "Ingredients",
              items: items,
            });
          }
        });

        // Collect steps
        const stepInputs = document.querySelectorAll(".step-input");
        stepInputs.forEach((input) => {
          const value = input.value.trim();
          if (value) {
            recipe.steps.push(value);
          }
        });

        // Collect macros
        const macrosItems = document.querySelectorAll(".macros-item");
        macrosItems.forEach((item) => {
          const key = item.querySelector(".macros-key").value.trim();
          const value = item.querySelector(".macros-value").value.trim();
          if (key && value) {
            recipe.macros[key] = value;
          }
        });

        return recipe;
      }
    </script>

    <!-- Profile Dropdown -->
    <script type="module">
      // Import Firebase functions
      import { getCurrentUser, getUserInfo, logoutUser } from "./firebase.js";
      import {
        getAuth,
        sendPasswordResetEmail,
      } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

      // DOM elements
      const profileImg = document.getElementById("profileImg");
      const profileDropdown = document.getElementById("profileDropdown");
      const usernameElement = document.getElementById("username");
      const headerUsernameElement = document.getElementById("headerUsername");
      const signoutBtn = document.getElementById("signoutBtn");
      const resetPasswordBtn = document.getElementById("resetPasswordBtn");
      const auth = getAuth();

      loadUserInfo();

      // Toggle dropdown when profile image is clicked
      profileImg.addEventListener("click", function (e) {
        e.stopPropagation();
        profileDropdown.classList.toggle("show");

        // Get and display current user info if dropdown is shown
        if (profileDropdown.classList.contains("show")) {
          loadUserInfo();
        }
      });

      // Close dropdown when clicking elsewhere on the page
      window.addEventListener("click", function () {
        if (profileDropdown.classList.contains("show")) {
          profileDropdown.classList.remove("show");
        }
      });

      // Prevent dropdown from closing when clicked inside
      profileDropdown.addEventListener("click", function (e) {
        e.stopPropagation();
      });

      // Handle sign out
      signoutBtn.addEventListener("click", async function () {
        const result = await logoutUser();
        if (result.success) {
          // Redirect to login page after successful logout
          window.location.href = "./login.html";
        } else {
          alert("Failed to sign out: " + result.error);
        }
      });

      // Handle reset password
      resetPasswordBtn.addEventListener("click", async function () {
        try {
          const user = await getCurrentUser();
          if (user && user.email) {
            await sendPasswordResetEmail(auth, user.email);
            alert("Password reset email sent! Check your inbox.");
            profileDropdown.classList.remove("show");
          } else {
            alert("You need to be logged in to reset your password.");
          }
        } catch (error) {
          alert("Error sending password reset email: " + error.message);
        }
      });

      // Load user information
      async function loadUserInfo() {
        try {
          // Get current authenticated user
          const user = await getCurrentUser();

          if (user) {
            // Get user info from Firestore
            const userInfo = await getUserInfo(user.uid);

            if (userInfo.success) {
              // Display username in both places
              usernameElement.textContent = userInfo.data.username;
              headerUsernameElement.textContent = userInfo.data.username;
            } else {
              usernameElement.textContent = "User";
              headerUsernameElement.textContent = "User";
              console.error("Failed to get user info:", userInfo.error);
            }
          } else {
            // User not logged in, redirect to login page
            usernameElement.textContent = "Guest";
            headerUsernameElement.textContent = "Guest";
          }
        } catch (error) {
          console.error("Error loading user info:", error);
          usernameElement.textContent = "Error";
          headerUsernameElement.textContent = "Error";
        }
      }

      // Check authentication status and load username when page loads
      document.addEventListener("DOMContentLoaded", async function () {
        loadUserInfo();
      });
    </script>

    <!-- Dark Mode Functionality -->
    <script>
      let darkmode = localStorage.getItem("darkmode");
      const themeSwitch = document.getElementById("toggle-button");

      // Function to enable dark mode
      const enableDarkmode = () => {
        document.body.classList.add("dark-mode"); // Add dark mode class
        localStorage.setItem("darkmode", "active"); // Save preference
        document.getElementById("light-icon").style.display = "none"; // Hide light icon
        document.getElementById("dark-icon").style.display = "block"; // Show dark icon
      };

      // Function to disable dark mode
      const disableDarkmode = () => {
        document.body.classList.remove("dark-mode"); // Remove dark mode class
        localStorage.setItem("darkmode", null); // Clear preference
        document.getElementById("light-icon").style.display = "block"; // Show light icon
        document.getElementById("dark-icon").style.display = "none"; // Hide dark icon
      };

      // Check for saved user preference, if any, on page load
      if (darkmode === "active") {
        enableDarkmode(); // Enable dark mode if preference is set
      } else {
        disableDarkmode(); // Otherwise, ensure light mode is active
      }

      // Add event listener for the theme switch button
      themeSwitch.addEventListener("click", () => {
        darkmode = localStorage.getItem("darkmode"); // Get current preference
        darkmode !== "active" ? enableDarkmode() : disableDarkmode(); // Toggle mode
      });
    </script>
  </body>
</html>
